<ion-app>
  <ion-header translucent="true">
    <ion-toolbar color="primary">
      <ion-buttons slot="start">
        <ion-button fill="clear">
          <img src="assets/velogiro_3.png" alt="Velogiro logo" class="app-title__logo" />
        </ion-button>
      </ion-buttons>
      <ion-title>Velogiro Trackassistant</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
    <ion-grid class="content-grid">
      <ion-row class="content-grid__row ion-align-items-stretch">
        <ion-col size="12" sizeMd="4">
          <ion-card class="upload-card">
            <ion-card-header>
              <ion-card-title>Upload GPX Track</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <p>Load a <code>.gpx</code> file exported from your GPS computer or Komoot collection.</p>
              <label class="file-picker">
                <span>Select GPX file</span>
                <input type="file" accept=".gpx,application/gpx+xml" (change)="onFileSelected($event)" />
              </label>

              @if (parseError()) {
                <p class="status status--error">{{ parseError() }}</p>
              } @else {
                @if (trackProfile(); as profile) {
                  <p class="status status--success">
                    Loaded {{ profile.totalDistanceKm | number: '1.1-2' }} km ·
                    Elevation {{ profile.minElevation | number: '1.0-0' }}–{{ profile.maxElevation | number: '1.0-0' }} m
                  </p>
                } @else {
                  <p class="status status--muted">GPX parsing is done entirely in-browser.</p>
                }
              }
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" sizeMd="8">
            <ion-card class="intro-card">
                <ion-card-header>
                    <ion-card-title>Predict Your Ride with Power-Perfect Precision</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <p class="hero__lead">
                        Import any GPX track, input your power output, and get realistic speed predictions for every climb and descent.</p>
                    <p class="hero__lead">Your ride, calculated down to the watt:</p>
                    <ul>
                        <li>Analyzes elevation and distance from your GPX data</li>
                        <li>Factors in bike type, total weight, and body weight</li>
                        <li>Calculates speed based on your sustainable power</li>
                    </ul>

                    <p class="hero__lead">Know your pace before you pedal—whether bikepacking, training, or tackling that mountain pass.
                    </p>
                </ion-card-content>
            </ion-card>

        </ion-col>
      </ion-row>

      <ion-row class="content-grid__row">
        <ion-col size="12">
          <ion-card class="bike-form-card">
            <ion-card-header>
              <ion-card-title>Ride Setup</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="bike-form">
          <div class="bike-form__row bike-form__row--primary">
            <div class="bike-form__type-select">
              <ion-select
                class="bike-form__field"
                fill="outline"
                label="Bike type"
                labelPlacement="stacked"
                interface="popover"
                [value]="bikeForm().bikeType"
                (ionChange)="onBikeTypeChange($event.detail.value)"
              >
                @for (option of bikeTypeOptions; track option.value) {
                  <ion-select-option [value]="option.value">{{ option.label }}</ion-select-option>
                }
              </ion-select>
              <button
                type="button"
                class="bike-form__toggle"
                (click)="toggleCoefficientRow()"
                [attr.aria-expanded]="showCoefficientRow()"
                aria-label="Toggle bike coefficients"
                [attr.data-tooltip]="showCoefficientRow() ? 'Hide bike type coefficients' : 'Show bike type coefficients'"
              >
                <ion-icon name="options-outline" aria-hidden="true"></ion-icon>
              </button>
            </div>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Bike weight with bags and cargo (kg)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0"
              step="0.1"
              [value]="bikeForm().bikeWeightKg"
              (ionInput)="onNumericInput('bikeWeightKg', $event)"
            ></ion-input>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Person weight (kg)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0"
              step="0.1"
              [value]="bikeForm().riderWeightKg"
              (ionInput)="onNumericInput('riderWeightKg', $event)"
            ></ion-input>
          </div>
          @if (showCoefficientRow()) {
            <div class="bike-form__row bike-form__row--coeffs">
              <ion-input
                class="bike-form__field"
                fill="outline"
                label="Rolling resistance Crr"
                labelPlacement="stacked"
                inputmode="decimal"
                type="number"
                min="0.001"
                step="0.0005"
                [value]="bikeForm().crr"
                (ionInput)="onNumericInput('crr', $event)"
              ></ion-input>
              <ion-input
                class="bike-form__field"
                fill="outline"
                label="Aerodynamic CdA (m²)"
                labelPlacement="stacked"
                inputmode="decimal"
                type="number"
                min="0.05"
                step="0.01"
                [value]="bikeForm().cda"
                (ionInput)="onNumericInput('cda', $event)"
              ></ion-input>
              <ion-input
                class="bike-form__field"
                fill="outline"
                label="Drivetrain efficiency (0-1)"
                labelPlacement="stacked"
                inputmode="decimal"
                type="number"
                min="0.5"
                max="1"
                step="0.01"
                [value]="bikeForm().efficiency"
                (ionInput)="onNumericInput('efficiency', $event)"
              ></ion-input>
            </div>
          }
          <div class="bike-form__row bike-form__row--power">
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Average power (W)"
              labelPlacement="stacked"
              inputmode="numeric"
              type="number"
              min="0"
              step="5"
              [value]="bikeForm().avgWatts"
              (ionInput)="onNumericInput('avgWatts', $event)"
            ></ion-input>
            <ion-select
              class="bike-form__field bike-form__field--profile"
              fill="outline"
              label="Power profile"
              labelPlacement="stacked"
              interface="popover"
              placeholder="Select profile"
              [value]="selectedPowerDistribution()"
              (ionChange)="onPowerDistributionChange($event.detail.value)"
            >
              <ion-select-option value="custom">Custom</ion-select-option>
              @for (profile of powerDistributions; track profile.id) {
                <ion-select-option [value]="profile.id">
                  {{ profile.label }} ({{ profile.range }})
                </ion-select-option>
              }
            </ion-select>
              <div class="bike-form__field bike-form__field--profile">.</div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
    </ion-col>
      </ion-row>

      <ion-row class="content-grid__row ion-align-items-stretch">
        <ion-col size="12">
    <ion-card class="graph-card">
      <ion-card-header>
        <ion-card-title>
          Distance & Elevation
          @if (gpxFileName()) {
            <span class="graph-card__filename">({{ gpxFileName() }})</span>
          }
        </ion-card-title>
      </ion-card-header>
      @if (trackProfile(); as profile) {
        <ion-card-content>
          <div class="graph-meta">
            <div>
              <span class="meta-label">Distance</span>
              <span class="meta-value">{{ profile.totalDistanceKm | number: '1.2-2' }} km</span>
            </div>
            <div>
              <span class="meta-label">Elevation</span>
              <span class="meta-value">
                {{ profile.minElevation | number: '1.0-0' }} – {{ profile.maxElevation | number: '1.0-0' }} m
              </span>
            </div>
            <div>
              <span class="meta-label">Ride effort</span>
              @if (rideEstimate(); as estimate) {
                <span class="meta-value">
                  {{ estimate.formatted }}
                  <span class="meta-sub">at</span>
                  <span class="meta-value">{{ bikeForm().avgWatts | number: '1.0-0' }} W</span>
                </span>
              } @else {
                <span class="meta-value meta-value--muted">Upload GPX to estimate time</span>
              }
            </div>
            <div>
              <span class="meta-label">Profile aligns with</span>
              <span class="meta-value">{{ riderTypeLabel() }}</span>
            </div>
            <div class="graph-meta__range">
              <ion-range
                min="50"
                max="400"
                step="5"
                labelPlacement="end"
                label="Average power"
                [value]="bikeForm().avgWatts"
                (ionInput)="onNumericInput('avgWatts', $event)"
              ></ion-range>
            </div>
          </div>
          <div class="graph-wrapper" #graphHost>
            <svg
              class="profile-graph"
              preserveAspectRatio="none"
              [attr.viewBox]="'0 0 ' + profile.graphWidth + ' ' + profile.graphHeight"
              role="img"
              aria-label="Elevation profile over distance"
            >
              <defs>
                <linearGradient id="gradientElevation" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="var(--ion-color-primary)" stop-opacity="0.4"></stop>
                  <stop offset="100%" stop-color="var(--ion-color-primary)" stop-opacity="0"></stop>
                </linearGradient>
              </defs>
              <rect class="graph-bg" width="100%" height="100%" />
              @if (timeTicks().length) {
                @for (tick of timeTicks(); track tick.timeSeconds; let last = $last) {
                  <line
                    class="graph-time-line"
                    [attr.x1]="tick.position"
                    [attr.x2]="tick.position"
                    [attr.y1]="profile.paddingTop"
                    [attr.y2]="profile.graphHeight"
                  />
                  @if (!last) {
                    <text
                      class="axis-label axis-label--time"
                      [attr.x]="clampLabelPosition(tick.position, profile.graphWidth)"
                      [attr.y]="profile.paddingTop - 8"
                      [attr.text-anchor]="labelAnchor(tick.position, profile.graphWidth)"
                    >
                      {{ tick.label }}
                    </text>
                  }
                }
              }
              @for (tick of profile.elevationTicks; track tick.value) {
                <line
                  class="graph-grid graph-grid--horizontal"
                  x1="0"
                  [attr.x2]="profile.graphWidth"
                  [attr.y1]="tick.position"
                  [attr.y2]="tick.position"
                />
                <text class="axis-label axis-label--horizontal" x="0" [attr.y]="tick.position - 4">
                  {{ tick.value | number: '1.0-0' }} m
                </text>
              }
              @for (tick of profile.distanceTicks; track tick.value) {
                <line
                  class="graph-grid graph-grid--vertical"
                  [attr.x1]="tick.position"
                  [attr.x2]="tick.position"
                  y1="0"
                  [attr.y2]="profile.graphHeight"
                />
                <text
                  class="axis-label axis-label--distance"
                  [attr.x]="clampLabelPosition(tick.position, profile.graphWidth)"
                  [attr.y]="profile.graphHeight - 4"
                  [attr.text-anchor]="labelAnchor(tick.position, profile.graphWidth)"
                >
                  {{ tick.value | number: '1.0-0' }} km
                </text>
              }
              <line
                class="graph-axis"
                x1="0"
                [attr.x2]="profile.graphWidth"
                [attr.y1]="profile.graphHeight"
                [attr.y2]="profile.graphHeight"
              />
              <path class="graph-fill" [attr.d]="profile.fillPath" />
              <path class="graph-line" [attr.d]="profile.linePath" />
              <text class="axis-label axis-label--top" x="0" y="18">
                {{ profile.maxElevation | number: '1.0-0' }} m
              </text>
              <text class="axis-label axis-label--bottom" x="0" [attr.y]="profile.graphHeight - 12">
                {{ profile.minElevation | number: '1.0-0' }} m
              </text>
            </svg>
          </div>
        </ion-card-content>
      } @else {
        <ion-card-content>
          <p class="status status--muted">Upload a GPX file to visualize the distance/elevation profile.</p>
        </ion-card-content>
      }
    </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <router-outlet />
  </ion-content>
</ion-app>
