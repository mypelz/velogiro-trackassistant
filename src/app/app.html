<ion-app>
  <ion-header translucent="true">
    <ion-toolbar color="primary">
      <ion-title>Velogiro Trackassistant</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
    <section class="hero ion-padding">
      <p class="hero__lead">
        Upload a GPX file to inspect the ride profile. Track points are parsed locally and displayed in an SVG
        chart inspired by Komoot's distance/elevation view.
      </p>
    </section>

    <ion-card class="upload-card">
          <ion-card-header>
              <ion-card-title>Upload GPX Track</ion-card-title>
          </ion-card-header>
          <ion-card-content>
              <p>Load a <code>.gpx</code> file exported from your GPS computer or Komoot collection.</p>
              <label class="file-picker">
                  <span>Select GPX file</span>
                  <input type="file" accept=".gpx,application/gpx+xml" (change)="onFileSelected($event)" />
              </label>

              @if (parseError()) {
                  <p class="status status--error">{{ parseError() }}</p>
              } @else {
                  @if (trackProfile(); as profile) {
                      <p class="status status--success">
                          Loaded {{ profile.totalDistanceKm | number: '1.1-2' }} km ·
                          Elevation {{ profile.minElevation | number: '1.0-0' }}–{{ profile.maxElevation | number: '1.0-0' }} m
                      </p>
                  } @else {
                      <p class="status status--muted">GPX parsing is done entirely in-browser.</p>
                  }
              }
          </ion-card-content>
      </ion-card>

    <ion-card class="bike-form-card">
      <ion-card-header>
        <ion-card-title>Ride Setup</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="bike-form">
          <div class="bike-form__row bike-form__row--presets">
            <div class="bike-form__type">
              <ion-select
                class="bike-form__field"
                fill="outline"
                label="Bike type"
                labelPlacement="stacked"
                interface="popover"
                [value]="bikeForm().bikeType"
                (ionChange)="onBikeTypeChange($event.detail.value)"
              >
                @for (option of bikeTypeOptions; track option.value) {
                  <ion-select-option [value]="option.value">{{ option.label }}</ion-select-option>
                }
              </ion-select>
              <span class="bike-form__arrow" aria-hidden="true">➜</span>
            </div>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Rolling resistance Crr"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0.001"
              step="0.0005"
              [value]="bikeForm().crr"
              (ionInput)="onNumericInput('crr', $event)"
            ></ion-input>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Aerodynamic CdA (m²)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0.05"
              step="0.01"
              [value]="bikeForm().cda"
              (ionInput)="onNumericInput('cda', $event)"
            ></ion-input>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Drivetrain efficiency (0-1)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0.5"
              max="1"
              step="0.01"
              [value]="bikeForm().efficiency"
              (ionInput)="onNumericInput('efficiency', $event)"
            ></ion-input>
          </div>
          <div class="bike-form__row bike-form__row--weights">
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Bike weight (kg)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0"
              step="0.1"
              [value]="bikeForm().bikeWeightKg"
              (ionInput)="onNumericInput('bikeWeightKg', $event)"
            ></ion-input>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Person weight (kg)"
              labelPlacement="stacked"
              inputmode="decimal"
              type="number"
              min="0"
              step="0.1"
              [value]="bikeForm().riderWeightKg"
              (ionInput)="onNumericInput('riderWeightKg', $event)"
            ></ion-input>
            <ion-input
              class="bike-form__field"
              fill="outline"
              label="Average power (W)"
              labelPlacement="stacked"
              inputmode="numeric"
              type="number"
              min="0"
              step="5"
              [value]="bikeForm().avgWatts"
              (ionInput)="onNumericInput('avgWatts', $event)"
            ></ion-input>
          </div>
        </div>
        <p class="bike-form__summary">
          Total system weight:
          <strong>{{ totalSystemWeightKg() | number: '1.0-1' }} kg</strong> · Average effort:
          <strong>{{ bikeForm().avgWatts | number: '1.0-0' }} W</strong>
          <br />
          Coefficients: Crr <strong>{{ bikeForm().crr | number: '1.3-3' }}</strong>,
          CdA <strong>{{ bikeForm().cda | number: '1.2-2' }} m²</strong>,
          η <strong>{{ bikeForm().efficiency | number: '1.2-2' }}</strong>
        </p>
      </ion-card-content>
    </ion-card>

    <ion-card class="graph-card">
      <ion-card-header>
        <ion-card-title>Distance & Elevation</ion-card-title>
      </ion-card-header>
      @if (trackProfile(); as profile) {
        <ion-card-content>
          <div class="graph-meta">
            <div>
              <span class="meta-label">Distance</span>
              <span class="meta-value">{{ profile.totalDistanceKm | number: '1.2-2' }} km</span>
            </div>
            <div>
              <span class="meta-label">Elevation</span>
              <span class="meta-value">
                {{ profile.minElevation | number: '1.0-0' }} – {{ profile.maxElevation | number: '1.0-0' }} m
              </span>
            </div>
            <div>
              <span class="meta-label">Ride effort</span>
              @if (rideEstimate(); as estimate) {
                <span class="meta-value">
                  {{ estimate.formatted }}
                  <span class="meta-sub">at {{ bikeForm().avgWatts | number: '1.0-0' }} W</span>
                </span>
              } @else {
                <span class="meta-value meta-value--muted">Upload GPX to estimate time</span>
              }
            </div>
          </div>
          <div class="graph-wrapper" #graphHost>
            <svg
              class="profile-graph"
              preserveAspectRatio="none"
              [attr.viewBox]="'0 0 ' + profile.graphWidth + ' ' + profile.graphHeight"
              role="img"
              aria-label="Elevation profile over distance"
            >
              <defs>
                <linearGradient id="gradientElevation" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="var(--ion-color-primary)" stop-opacity="0.4"></stop>
                  <stop offset="100%" stop-color="var(--ion-color-primary)" stop-opacity="0"></stop>
                </linearGradient>
              </defs>
              <rect class="graph-bg" width="100%" height="100%" />
              @if (timeTicks().length) {
                @for (tick of timeTicks(); track tick.timeSeconds; let last = $last) {
                  <line
                    class="graph-time-line"
                    [attr.x1]="tick.position"
                    [attr.x2]="tick.position"
                    [attr.y1]="profile.paddingTop"
                    [attr.y2]="profile.graphHeight"
                  />
                  @if (!last) {
                    <text
                      class="axis-label axis-label--time"
                      [attr.x]="clampLabelPosition(tick.position, profile.graphWidth)"
                      [attr.y]="profile.paddingTop - 8"
                      [attr.text-anchor]="labelAnchor(tick.position, profile.graphWidth)"
                    >
                      {{ tick.label }}
                    </text>
                  }
                }
              }
              @for (tick of profile.elevationTicks; track tick.value) {
                <line
                  class="graph-grid graph-grid--horizontal"
                  x1="0"
                  [attr.x2]="profile.graphWidth"
                  [attr.y1]="tick.position"
                  [attr.y2]="tick.position"
                />
                <text class="axis-label axis-label--horizontal" x="0" [attr.y]="tick.position - 4">
                  {{ tick.value | number: '1.0-0' }} m
                </text>
              }
              @for (tick of profile.distanceTicks; track tick.value) {
                <line
                  class="graph-grid graph-grid--vertical"
                  [attr.x1]="tick.position"
                  [attr.x2]="tick.position"
                  y1="0"
                  [attr.y2]="profile.graphHeight"
                />
                <text
                  class="axis-label axis-label--distance"
                  [attr.x]="clampLabelPosition(tick.position, profile.graphWidth)"
                  [attr.y]="profile.graphHeight - 4"
                  [attr.text-anchor]="labelAnchor(tick.position, profile.graphWidth)"
                >
                  {{ tick.value | number: '1.0-0' }} km
                </text>
              }
              <line
                class="graph-axis"
                x1="0"
                [attr.x2]="profile.graphWidth"
                [attr.y1]="profile.graphHeight"
                [attr.y2]="profile.graphHeight"
              />
              <path class="graph-fill" [attr.d]="profile.fillPath" />
              <path class="graph-line" [attr.d]="profile.linePath" />
              <text class="axis-label axis-label--top" x="0" y="18">
                {{ profile.maxElevation | number: '1.0-0' }} m
              </text>
              <text class="axis-label axis-label--bottom" x="0" [attr.y]="profile.graphHeight - 12">
                {{ profile.minElevation | number: '1.0-0' }} m
              </text>
            </svg>
          </div>
        </ion-card-content>
      } @else {
        <ion-card-content>
          <p class="status status--muted">Upload a GPX file to visualize the distance/elevation profile.</p>
        </ion-card-content>
      }
    </ion-card>

    <router-outlet />
  </ion-content>
</ion-app>
